## dh-secure-chat

End‑to‑end зашифрованный real‑time мессенджер 1‑на‑1 на Go (backend) и TypeScript/React (frontend) с использованием Diffie‑Hellman для установления сессионного ключа и симметричного шифрования на клиенте. Репозиторий: [`dh-secure-chat`](https://github.com/AlibekovAA/dh-secure-chat).

### Цели проекта

- **Real‑time чат 1‑на‑1** без хранения сообщений на сервере.
- **E2E‑шифрование**: все сообщения шифруются и расшифровываются только на клиентах.
- **DH‑обмен ключами** для установления отдельного сессионного ключа на каждый чат.
- **Простое развёртывание** через Docker и `docker-compose` на один сервер.

---

## Основной стек

- **Frontend**

  - React + TypeScript (SPA).
  - Tailwind CSS.
  - WebSocket‑клиент для real‑time сообщений.
  - Web Crypto API для работы с ключами и симметричным шифрованием.

- **Backend**

  - Go, стандартная библиотека `net/http`.
  - Отдельный **auth‑service** (HTTP + JWT).
  - Сервис чата с WebSocket‑hub'ом.
  - PostgreSQL (только пользователи и публичные identity‑ключи).

- **Инфраструктура**
  - Docker, `docker-compose`.
  - Reverse proxy (Nginx) для HTTPS и роутинга HTTP/WS.

---

## Функциональные требования

### Пользователи и аутентификация

- **Регистрация**

  - username + пароль.
  - На клиенте генерируется долгоживущая **identity‑ключевая пара**.
  - На сервер уходит только публичный `identity`‑ключ, приватный ключ всегда остаётся на клиенте.

- **Логин**

  - Аутентификация по `username + password`.
  - Auth‑service выдаёт **JWT** (TTL 15 минут) и **refresh token** (httpOnly cookie, TTL 7 дней).
  - Refresh token используется для автоматического обновления access token.
  - JWT используется для REST‑запросов (Authorization: Bearer …) и авторизации WebSocket‑подключений.

- **Профиль и поиск**
  - `GET /api/chat/me` — информация о текущем пользователе.
  - Поиск пользователя по `username` для старта диалога.
  - `GET /api/identity/users/{id}/key` — получение публичного identity‑ключа.
  - `GET /api/identity/users/{id}/fingerprint` — получение fingerprint для верификации.

### Real‑time чат (только при одновременном онлайне)

- Только **1‑на‑1** диалоги.
- Чат‑сессия существует, пока **оба участника подключены по WebSocket**.
- При отключении любого участника:

  - чат‑сессия завершается;
  - история сообщений больше не доступна (сообщения хранятся только в памяти клиента).

- **Сообщения**
  - отправляются и принимаются только через WebSocket;
  - не буферизуются и не доставляются позже;
  - не сохраняются в БД, не логируются и не кэшируются на сервере;
  - на сервере виден только шифротекст + nonce + минимальные метаданные (отправитель/получатель, technical ids).

### UI‑состояния

- `peer offline` — собеседник не в сети, чат недоступен.
- `establishing secure session` — идёт DH‑обмен и установка сессионного ключа.
- `secure session active` — установлена защищённая сессия, можно переписываться.
- `peer disconnected` — один из участников отключился, сессия завершена, история очищена из UI.

---

## Криптография и безопасность

### Identity‑keys

- На клиенте генерируется долгоживущая ключевая пара `identity` при регистрации.
- Публичный ключ отправляется на сервер и хранится в БД.
- Приватный ключ не покидает устройство.
- **Примечание**: Identity-ключи используются для идентификации пользователя. Для установки сессионного ключа используются ephemeral-ключи (см. ниже).

### Сессионный ключ

- Для каждого чата создаётся отдельная **Diffie‑Hellman‑сессия**:
  - клиенты генерируют ephemeral‑ключи;
  - обмениваются публичными ephemeral‑ключами через служебные WebSocket‑сообщения;
  - общий секрет прогоняется через KDF для получения симметричного ключа шифрования сообщений.

### Шифрование сообщений

- Все сообщения шифруются на клиенте.
- На сервер уходят только:
  - ciphertext;
  - nonce/iv;
  - минимальные служебные поля (id чата, id отправителя/получателя).
- Сервер **никогда не может расшифровать** сообщение.

### Fingerprint‑верификация

- Для каждого собеседника отображается **fingerprint** его публичного identity‑ключа (SHA‑256).
- Визуальное представление через эмодзи для упрощения сравнения по телефону.
- Автоматическое сохранение fingerprint при первом контакте (TOFU).
- Блокировка чата при изменении fingerprint у verified peer.
- История изменений fingerprint для детекции атак.
- Экспорт/импорт verified peers для многоустройственности.

---

## Нефункциональные требования

- **Отсутствие персистентности сообщений**

  - БД хранит только пользователей и их публичные identity‑ключи.
  - Сообщения никогда не пишутся в БД, не логируются и не кэшируются на сервере.

- **Безопасность**

  - HTTPS на уровне reverse‑proxy (Nginx).
  - Безопасное хранение паролей (bcrypt).
  - Refresh tokens в httpOnly cookies с `SameSite=Strict`.
  - Access tokens хранятся только в памяти клиента.
  - Лимит активных refresh tokens на пользователя (5).
  - Автоматическая очистка expired refresh tokens.
  - Trace ID для корреляции логов между сервисами (генерируется автоматически, передаётся в заголовке `X-Trace-ID`).

- **Простое развёртывание**

  - Один `docker-compose.yml` для:
    - frontend (React + Tailwind);
    - backend (auth‑service + chat‑service);
    - PostgreSQL;
    - Proxy (Nginx).

---

## Метрики

### Auth‑service

- Экспорт через `expvar` доступен по HTTP‑эндпоинту `GET /debug/vars` на порту auth‑сервиса (`AUTH_HTTP_PORT`, по умолчанию `8081`).
- Примеры:
  - внутри контейнера: `curl -s localhost:8081/debug/vars | jq`
  - с хоста (если порт проброшен): `curl -s http://localhost:8081/debug/vars`
  - `Invoke-RestMethod -Uri http://localhost:8081/debug/vars | ConvertTo-Json -Depth 5`
- Основные метрики:
  - `auth_requests_total` — общее число запросов;
  - `auth_requests_in_flight` — текущее число обрабатываемых запросов;
  - `auth_request_duration_ms` — сумма длительностей по пути/методу;
  - `auth_last_status_by_path` — последний класс статуса (`2xx`, `4xx`, …) по пути/методу;
  - `auth_last_duration_seconds_by_path` — последняя длительность запроса по пути/методу;
  - `refresh_tokens_issued` — количество выданных refresh tokens;
  - `refresh_tokens_used` — количество использованных refresh tokens;
  - `refresh_tokens_revoked` — количество отозванных refresh tokens;
  - `refresh_tokens_expired` — количество истёкших refresh tokens.

### Chat‑service

- Экспорт через `expvar` доступен по HTTP‑эндпоинту `GET /debug/vars` на порту chat‑сервиса (`CHAT_HTTP_PORT`, по умолчанию `8082`).
- Примеры:
  - внутри контейнера: `curl -s localhost:8082/debug/vars | jq`
  - с хоста (если порт проброшен): `curl -s http://localhost:8082/debug/vars`
  - `Invoke-RestMethod -Uri http://localhost:8082/debug/vars | ConvertTo-Json -Depth 5`
- Основные метрики:
  - `chat_requests_total` — общее число запросов;
  - `chat_requests_in_flight` — текущее число обрабатываемых запросов;
  - `chat_request_duration_ms` — сумма длительностей по пути/методу;
  - `chat_last_status_by_path` — последний класс статуса (`2xx`, `4xx`, …) по пути/методу;
  - `chat_last_duration_seconds_by_path` — последняя длительность запроса по пути/методу.

---

## Архитектура (high‑level)

### Frontend (React + TS + Tailwind)

- SPA с основными модулями:
  - аутентификация (регистрация/логин, автоматический refresh токенов);
  - список пользователей и выбор собеседника;
  - управление ключами (identity + ephemeral);
  - DH‑обмен и установка сессионного ключа;
  - E2E‑шифрование/дешифрование сообщений;
  - WebSocket‑клиент и отображение UI‑состояний чата;
  - fingerprint‑верификация с визуальным сравнением (эмодзи);
  - автоматическая блокировка чата при изменении fingerprint.

### Backend (Go, net/http)

- **Auth‑service**

  - Регистрация/логин.
  - Валидация учётных данных, хэширование паролей.
  - Генерация и валидация JWT (access token, TTL 15 минут).
  - Управление refresh tokens (выдача, обновление, отзыв).
  - Автоматическая очистка expired refresh tokens.
  - Создание identity‑ключей при регистрации.

- **Identity‑service**

  - Управление публичными identity‑ключами пользователей.
  - Генерация fingerprint (SHA‑256 от публичного ключа).
  - API для получения публичных ключей и fingerprint.

- **Chat‑service**

  - REST‑эндпоинты для:
    - `GET /api/chat/me` — информация о текущем пользователе;
    - `GET /api/chat/users?username=...` — поиск пользователя по username;
    - `GET /api/chat/users/{id}/identity-key` — получение публичного identity‑ключа пользователя.
  - WebSocket‑эндпоинт:
    - `WS /ws/?token=...` — подключение к WebSocket‑hub (JWT передаётся в query параметре).
  - WebSocket‑hub для:
    - управления подключениями пользователей;
    - маршрутизации зашифрованных сообщений 1‑на‑1;
    - служебных сообщений (ephemeral ключи, статусы доставки/онлайна);
    - обновления `last_seen_at` с таймаутом (debounce, не чаще раза в минуту).

- **База данных (PostgreSQL)**

  - Таблица пользователей с полем `last_seen_at` для отслеживания активности.
  - Таблица публичных identity‑ключей.
  - Таблица refresh tokens с метаданными (user_agent, ip_address).
  - Простые SQL‑скрипты для инициализации схемы.

- **Reverse‑proxy**
  - TLS‑терминация (HTTPS).
  - Роутинг HTTP/WS на backend‑сервисы.

---

## Планируемые улучшения

- Подпись ephemeral‑ключей identity‑приватным ключом для защиты от MITM.
- Rate limiting для защиты от брутфорса и DDoS.
- Sanitization для всех пользовательских вводов.
- Acknowledge mechanism для критичных сообщений (ephemeral keys).
- Retry‑логика при заполнении WebSocket send‑буфера с экспоненциальным backoff.
- Возможность отправки файлов и голосовых сообщений
