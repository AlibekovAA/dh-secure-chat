## dh-secure-chat

End‑to‑end зашифрованный real‑time мессенджер 1‑на‑1 на Go (backend) и TypeScript/React (frontend) с использованием Diffie‑Hellman для установления сессионного ключа и симметричного шифрования на клиенте. Репозиторий: [`dh-secure-chat`](https://github.com/AlibekovAA/dh-secure-chat).

### Цели проекта

- **Real‑time чат 1‑на‑1** без хранения сообщений на сервере.
- **E2E‑шифрование**: все сообщения шифруются и расшифровываются только на клиентах.
- **DH‑обмен ключами** для установления отдельного сессионного ключа на каждый чат.
- **Простое развёртывание** через Docker и `docker-compose` на один сервер.

---

## Основной стек

- **Frontend**

  - React + TypeScript (SPA).
  - Tailwind CSS.
  - WebSocket‑клиент для real‑time сообщений.
  - Web Crypto API для работы с ключами и симметричным шифрованием.
  - MediaRecorder API для записи голосовых сообщений.
  - getUserMedia API для доступа к микрофону.

- **Backend**

  - Go, стандартная библиотека `net/http`.
  - Отдельный **auth‑service** (HTTP + JWT).
  - Сервис чата с WebSocket‑hub'ом.
  - PostgreSQL (только пользователи и публичные identity‑ключи).

- **Инфраструктура**
  - Docker, `docker-compose`.
  - Reverse proxy (Nginx) для HTTPS и роутинга HTTP/WS.

---

## Функциональные требования

### Пользователи и аутентификация

- **Регистрация**

  - username + пароль.
  - На клиенте генерируется долгоживущая **identity‑ключевая пара**.
  - На сервер уходит только публичный `identity`‑ключ, приватный ключ всегда остаётся на клиенте.

- **Логин**

  - Аутентификация по `username + password`.
  - Auth‑service выдаёт **JWT** (TTL 15 минут) с уникальным **JTI** (JWT ID) и **refresh token** (httpOnly cookie, TTL 7 дней).
  - Refresh token используется для автоматического обновления access token.
  - JWT используется для REST‑запросов (Authorization: Bearer …) и авторизации WebSocket‑подключений.
  - JTI позволяет инвалидировать access tokens до истечения их срока действия.

- **Инвалидация токенов**

  - `POST /api/auth/revoke` — инвалидация текущего access token (требует Authorization header).
  - При logout инвалидируются как access token (если передан), так и refresh token.
  - Инвалидированные токены проверяются при каждой валидации JWT.
  - Автоматическая очистка expired revoked tokens.

- **Профиль и поиск**
  - `GET /api/chat/me` — информация о текущем пользователе.
  - Поиск пользователя по `username` для старта диалога.
  - `GET /api/identity/users/{id}/key` — получение публичного identity‑ключа.
  - `GET /api/identity/users/{id}/fingerprint` — получение fingerprint для верификации.

### Real‑time чат (только при одновременном онлайне)

- Только **1‑на‑1** диалоги.
- Чат‑сессия существует, пока **оба участника подключены по WebSocket**.
- При отключении любого участника:

  - чат‑сессия завершается;
  - история сообщений больше не доступна (сообщения хранятся только в памяти клиента).

- **Сообщения**

  - отправляются и принимаются только через WebSocket;
  - не буферизуются и не доставляются позже;
  - не сохраняются в БД, не логируются и не кэшируются на сервере;
  - на сервере виден только шифротекст + nonce + минимальные метаданные (отправитель/получатель, technical ids).

- **Отправка файлов**

  - поддержка отправки файлов до 50MB;
  - файлы шифруются на клиенте перед отправкой;
  - разбиение на чанки по 1MB для передачи через WebSocket;
  - каждый чанк шифруется отдельно с использованием сессионного ключа;
  - файлы передаются только при активной защищённой сессии;
  - файлы не сохраняются на сервере, передаются напрямую между клиентами.

- **Голосовые сообщения**
  - запись голосовых сообщений через MediaRecorder API;
  - поддержка форматов: WebM (Opus), OGG (Opus), MP4, MPEG;
  - максимальная длительность записи: 5 минут;
  - максимальный размер: 10MB;
  - автоматическое определение голосовых сообщений по MIME-типу;
  - отображение с проигрывателем и прогресс-баром;
  - голосовые сообщения передаются как зашифрованные файлы через тот же механизм;
  - требуется поддержка браузером MediaRecorder API и getUserMedia API.

### UI‑состояния

- `peer offline` — собеседник не в сети, чат недоступен.
- `establishing secure session` — идёт DH‑обмен и установка сессионного ключа.
- `secure session active` — установлена защищённая сессия, можно переписываться.
- `peer disconnected` — один из участников отключился, сессия завершена, история очищена из UI.

---

## Криптография и безопасность

### Identity‑keys

- На клиенте генерируется долгоживущая ключевая пара `identity` при регистрации.
- Публичный ключ отправляется на сервер и хранится в БД.
- Приватный ключ не покидает устройство.
- **Примечание**: Identity-ключи используются для идентификации пользователя. Для установки сессионного ключа используются ephemeral-ключи (см. ниже).

### Сессионный ключ

- Для каждого чата создаётся отдельная **Diffie‑Hellman‑сессия**:
  - клиенты генерируют ephemeral‑ключи;
  - ephemeral‑ключи подписываются приватным identity‑ключом для защиты от MITM‑атак;
  - обмениваются публичными ephemeral‑ключами и подписями через служебные WebSocket‑сообщения;
  - подписи проверяются перед использованием ключей;
  - общий секрет прогоняется через KDF для получения симметричного ключа шифрования сообщений;
  - используется acknowledge mechanism для подтверждения получения критичных сообщений (ephemeral keys).

### Шифрование сообщений

- Все сообщения, файлы и голосовые сообщения шифруются на клиенте.
- Используется AES-GCM для симметричного шифрования.
- На сервер уходят только:
  - ciphertext;
  - nonce/iv;
  - минимальные служебные поля (id чата, id отправителя/получателя, MIME-тип для файлов).
- Сервер **никогда не может расшифровать** сообщение, файл или голосовое сообщение.
- Файлы и голосовые сообщения разбиваются на чанки и шифруются по частям для эффективной передачи.

### Fingerprint‑верификация

- Для каждого собеседника отображается **fingerprint** его публичного identity‑ключа (SHA‑256).
- Визуальное представление через эмодзи для упрощения сравнения по телефону.
- Автоматическое сохранение fingerprint при первом контакте (TOFU).
- Блокировка чата при изменении fingerprint у verified peer.
- История изменений fingerprint для детекции атак.
- Экспорт/импорт verified peers для многоустройственности.

---

## Нефункциональные требования

- **Отсутствие персистентности сообщений**

  - БД хранит только пользователей и их публичные identity‑ключи.
  - Сообщения никогда не пишутся в БД, не логируются и не кэшируются на сервере.

- **Безопасность**

  - HTTPS на уровне reverse‑proxy (Nginx).
  - Безопасное хранение паролей (bcrypt).
  - Refresh tokens в httpOnly cookies с `SameSite=Strict`.
  - Access tokens хранятся только в памяти клиента.
  - Лимит активных refresh tokens на пользователя (5).
  - Автоматическая очистка expired refresh tokens и revoked tokens.
  - JTI (JWT ID) в каждом access token для возможности инвалидации.
  - Проверка revoked tokens при каждой валидации JWT (в REST и WebSocket).
  - Trace ID для корреляции логов между сервисами (генерируется автоматически, передаётся в заголовке `X-Trace-ID`).

- **Простое развёртывание**

  - Один `docker-compose.yml` для:
    - frontend (React + Tailwind);
    - backend (auth‑service + chat‑service);
    - PostgreSQL;
    - Proxy (Nginx).

---

## Метрики

### Auth‑service

- Экспорт через `expvar` доступен по HTTP‑эндпоинту `GET /debug/vars` на порту auth‑сервиса (`AUTH_HTTP_PORT`, по умолчанию `8081`).
- Примеры:
  - внутри контейнера: `curl -s localhost:8081/debug/vars | jq`
  - с хоста (если порт проброшен): `curl -s http://localhost:8081/debug/vars`
  - `Invoke-RestMethod -Uri http://localhost:8081/debug/vars | ConvertTo-Json -Depth 5`
- Основные метрики:
  - `auth_requests_total` — общее число запросов;
  - `auth_requests_in_flight` — текущее число обрабатываемых запросов;
  - `auth_request_duration_ms` — сумма длительностей по пути/методу;
  - `auth_last_status_by_path` — последний класс статуса (`2xx`, `4xx`, …) по пути/методу;
  - `auth_last_duration_seconds_by_path` — последняя длительность запроса по пути/методу;
  - `refresh_tokens_issued` — количество выданных refresh tokens;
  - `refresh_tokens_used` — количество использованных refresh tokens;
  - `refresh_tokens_revoked` — количество отозванных refresh tokens;
  - `refresh_tokens_expired` — количество истёкших refresh tokens;
  - `refresh_tokens_cleanup_deleted` — количество удалённых expired refresh tokens при cleanup;
  - `access_tokens_issued` — количество выданных access tokens;
  - `access_tokens_revoked` — количество инвалидированных access tokens;
  - `revoked_tokens_cleanup_deleted` — количество удалённых expired revoked tokens при cleanup;
  - `jwt_validations_total` — общее количество проверок JWT токенов;
  - `jwt_validations_failed` — количество неудачных проверок JWT;
  - `jwt_revoked_checks_total` — количество проверок revoked tokens.

### Chat‑service

- Экспорт через `expvar` доступен по HTTP‑эндпоинту `GET /debug/vars` на порту chat‑сервиса (`CHAT_HTTP_PORT`, по умолчанию `8082`).
- Примеры:
  - внутри контейнера: `curl -s localhost:8082/debug/vars | jq`
  - с хоста (если порт проброшен): `curl -s http://localhost:8082/debug/vars`
  - `Invoke-RestMethod -Uri http://localhost:8082/debug/vars | ConvertTo-Json -Depth 5`
- Основные метрики:
  - `chat_requests_total` — общее число запросов;
  - `chat_requests_in_flight` — текущее число обрабатываемых запросов;
  - `chat_request_duration_ms` — сумма длительностей по пути/методу;
  - `chat_last_status_by_path` — последний класс статуса (`2xx`, `4xx`, …) по пути/методу;
  - `chat_last_duration_seconds_by_path` — последняя длительность запроса по пути/методу;
  - `chat_websocket_connections_active` — текущее число активных WebSocket подключений;
  - `chat_websocket_connections_total` — общее число установленных WebSocket подключений;
  - `chat_websocket_errors` — количество ошибок WebSocket по типам;
  - `chat_websocket_messages_total` — количество сообщений WebSocket по типам (message, ephemeral_key, session_established, ack, file_start, file_chunk, file_complete);
  - `chat_websocket_files_total` — количество отправленных файлов;
  - `chat_websocket_files_chunks_total` — количество переданных чанков файлов;
  - `db_pool_acquired_connections` — количество активных соединений с БД;
  - `db_pool_idle_connections` — количество простаивающих соединений с БД;
  - `db_pool_max_connections` — максимальное количество соединений в пуле;
  - `db_pool_total_connections` — общее количество соединений в пуле.

---

## Архитектура (high‑level)

### Frontend (React + TS + Tailwind)

- SPA с основными модулями:
  - аутентификация (регистрация/логин, автоматический refresh токенов);
  - список пользователей и выбор собеседника;
  - управление ключами (identity + ephemeral);
  - DH‑обмен и установка сессионного ключа с подписью ephemeral‑ключей;
  - E2E‑шифрование/дешифрование сообщений, файлов и голосовых сообщений;
  - WebSocket‑клиент и отображение UI‑состояний чата;
  - отправка и получение файлов с автоматическим шифрованием;
  - запись и отправка голосовых сообщений (MediaRecorder API);
  - воспроизведение голосовых сообщений с контролем прогресса;
  - fingerprint‑верификация с визуальным сравнением (эмодзи);
  - автоматическая блокировка чата при изменении fingerprint;
  - acknowledge mechanism для критичных сообщений;
  - проверка поддержки браузером необходимых API (Web Crypto, MediaRecorder, getUserMedia).

### Backend (Go, net/http)

- **Auth‑service**

  - Регистрация/логин.
  - Валидация учётных данных, хэширование паролей.
  - Генерация и валидация JWT (access token, TTL 15 минут) с JTI для инвалидации.
  - Управление refresh tokens (выдача, обновление, отзыв).
  - Инвалидация access tokens через JTI-based blacklist.
  - Автоматическая очистка expired refresh tokens и revoked tokens.
  - Создание identity‑ключей при регистрации.
  - Endpoint `POST /api/auth/revoke` для инвалидации текущего access token.

- **Identity‑service**

  - Управление публичными identity‑ключами пользователей.
  - Генерация fingerprint (SHA‑256 от публичного ключа).
  - API для получения публичных ключей и fingerprint.

- **Chat‑service**

  - REST‑эндпоинты для:
    - `GET /api/chat/me` — информация о текущем пользователе;
    - `GET /api/chat/users?username=...` — поиск пользователя по username;
    - `GET /api/chat/users/{id}/identity-key` — получение публичного identity‑ключа пользователя.
  - WebSocket‑эндпоинт:
    - `WS /ws/` — подключение к WebSocket‑hub (JWT передаётся в первом сообщении типа `auth`).
  - WebSocket‑hub для:
    - управления подключениями пользователей;
    - маршрутизации зашифрованных сообщений, файлов и голосовых сообщений 1‑на‑1;
    - служебных сообщений (ephemeral ключи, acknowledge, статусы доставки/онлайна);
    - передачи файлов и голосовых сообщений по частям (file_start, file_chunk, file_complete);
    - валидации MIME-типов для аудио файлов;
    - обновления `last_seen_at` с таймаутом (debounce, не чаще раза в минуту).

- **База данных (PostgreSQL)**

  - Таблица пользователей с полем `last_seen_at` для отслеживания активности.
  - Таблица публичных identity‑ключей.
  - Таблица refresh tokens с метаданными (user_agent, ip_address).
  - Таблица revoked tokens для инвалидации access tokens (JTI-based blacklist).

- **Reverse‑proxy**
  - TLS‑терминация (HTTPS).
  - Роутинг HTTP/WS на backend‑сервисы.

---

## Планируемые улучшения

- Интеграция с системами мониторинга (Prometheus/Grafana).
- Не работает отправка голосового и фото/документа. Неправильно отображается продолжительность голосового.
- Текст "печатает..." когда собеседник кликнул в поле ввода (индикатор печати).
- При протухании токена (15 мин) выводится сообщение "не удалось найти приватный ключ".
