## dh-secure-chat

End‑to‑end зашифрованный real‑time мессенджер 1‑на‑1 на Go (backend) и TypeScript/React (frontend) с использованием Diffie‑Hellman для установления сессионного ключа и симметричного шифрования на клиенте. Репозиторий: [`dh-secure-chat`](https://github.com/AlibekovAA/dh-secure-chat).

### Цели проекта

- **Real‑time чат 1‑на‑1** без хранения сообщений на сервере.
- **E2E‑шифрование**: все сообщения шифруются и расшифровываются только на клиентах.
- **DH‑обмен ключами** для установления отдельного сессионного ключа на каждый чат.
- **Простое развёртывание** через Docker и `docker-compose` на один сервер.

---

## Основной стек

- **Frontend**

  - React + TypeScript (SPA).
  - Tailwind CSS.
  - WebSocket‑клиент для real‑time сообщений.
  - Web Crypto API для работы с ключами и симметричным шифрованием.

- **Backend**

  - Go, стандартная библиотека `net/http`.
  - Отдельный **auth‑service** (HTTP + JWT).
  - Сервис чата с WebSocket‑hub'ом.
  - PostgreSQL (только пользователи и публичные identity‑ключи).

- **Инфраструктура**
  - Docker, `docker-compose`.
  - Reverse proxy (Nginx) для HTTPS и роутинга HTTP/WS.

---

## Функциональные требования

### Пользователи и аутентификация

- **Регистрация**

  - username + пароль.
  - На клиенте генерируется долгоживущая **identity‑ключевая пара**.
  - На сервер уходит только публичный `identity`‑ключ, приватный ключ всегда остаётся на клиенте.

- **Логин**

  - Аутентификация по `username + password`.
  - Auth‑service выдаёт **JWT**, который используется:
    - для REST‑запросов (Authorization: Bearer …);
    - для авторизации WebSocket‑подключений.

- **Профиль и поиск**
  - `GET /me` — информация о текущем пользователе.
  - Поиск пользователя по `username` для старта диалога и получения его публичного `identity`‑ключа.

### Real‑time чат (только при одновременном онлайне)

- Только **1‑на‑1** диалоги.
- Чат‑сессия существует, пока **оба участника подключены по WebSocket**.
- При отключении любого участника:

  - чат‑сессия завершается;
  - история сообщений больше не доступна (сообщения хранятся только в памяти клиента).

- **Сообщения**
  - отправляются и принимаются только через WebSocket;
  - не буферизуются и не доставляются позже;
  - не сохраняются в БД, не логируются и не кэшируются на сервере;
  - на сервере виден только шифротекст + nonce + минимальные метаданные (отправитель/получатель, technical ids).

### UI‑состояния

- `peer offline` — собеседник не в сети, чат недоступен.
- `establishing secure session` — идёт DH‑обмен и установка сессионного ключа.
- `secure session active` — установлена защищённая сессия, можно переписываться.
- `peer disconnected` — один из участников отключился, сессия завершена, история очищена из UI.

---

## Криптография и безопасность

### Identity‑keys

- На клиенте генерируется долгоживущая ключевая пара `identity`.
- Публичный ключ отправляется на сервер и хранится в БД.
- Приватный ключ не покидает устройство.

### Сессионный ключ

- Для каждого чата создаётся отдельная **Diffie‑Hellman‑сессия**:
  - клиенты генерируют ephemeral‑ключи;
  - обмениваются публичными ephemeral‑ключами через служебные WebSocket‑сообщения;
  - общий секрет прогоняется через KDF для получения симметричного ключа шифрования сообщений.

### Шифрование сообщений

- Все сообщения шифруются на клиенте.
- На сервер уходят только:
  - ciphertext;
  - nonce/iv;
  - минимальные служебные поля (id чата, id отправителя/получателя).
- Сервер **никогда не может расшифровать** сообщение.

### Fingerprint‑верификация (первая версия)

- Для каждого собеседника отображается **fingerprint** его публичных ключей (identity/ephemeral).
- Пользователи могут сверить fingerprint по другому каналу связи.
- При расхождении fingerprint UI явно предупреждает о возможной атаке «man‑in‑the‑middle».

---

## Нефункциональные требования

- **Отсутствие персистентности сообщений**

  - БД хранит только пользователей и их публичные identity‑ключи.
  - Сообщения никогда не пишутся в БД, не логируются и не кэшируются на сервере.

- **Безопасность**

  - HTTPS на уровне reverse‑proxy (Nginx).
  - Безопасное хранение паролей (bcrypt).

- **Простое развёртывание**

  - Один `docker-compose.yml` для:
    - frontend (React + Tailwind);
    - backend (auth‑service + chat‑service);
    - PostgreSQL;
    - Proxy (Nginx).

---

## Архитектура (high‑level)

### Frontend (React + TS + Tailwind)

- SPA с основными модулями:
  - аутентификация (регистрация/логин, управление JWT);
  - список пользователей и выбор собеседника;
  - управление ключами (identity + ephemeral);
  - DH‑обмен и установка сессионного ключа;
  - E2E‑шифрование/дешифрование сообщений;
  - WebSocket‑клиент и отображение UI‑состояний чата;
  - экран/модальное окно для fingerprint‑верификации.

### Backend (Go, net/http)

- **Auth‑service**

  - Регистрация/логин.
  - Валидация учётных данных, хэширование паролей.
  - Генерация и валидация JWT.

- **Chat‑service**

  - REST‑эндпоинты для:
    - `GET /me`;
    - поиск пользователя по username;
    - выдача публичных identity‑ключей.
  - WebSocket‑hub для:
    - управления подключениями пользователей;
    - маршрутизации зашифрованных сообщений 1‑на‑1;
    - служебных сообщений (ephemeral ключи, статусы доставки/онлайна).

- **База данных (PostgreSQL)**

  - Таблица пользователей.
  - Таблица публичных identity‑ключей (если не инлайн в users).
  - Простые SQL‑скрипты для инициализации схемы.

- **Reverse‑proxy**
  - TLS‑терминация (HTTPS).
  - Роутинг HTTP/WS на backend‑сервисы.
